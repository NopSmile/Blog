<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>tricks</title><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:first-child { margin-top: -20px; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; }
button, input, select, textarea { color: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; font-size: inherit; line-height: inherit; font-family: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 2; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px !important; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 32px; padding-right: 32px; padding-bottom: 0px; break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  @page { margin: 20mm 0px; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="mermaid"] svg, [lang="flow"] svg { max-width: 100%; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow-y: hidden; overflow-x: auto; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root { --active-file-bg-color: rgba(32, 43, 51, 0.63); --active-file-text-color: white; --bg-color: #fff; --text-color: #333; --side-bar-bg-color: #f5f5f5; --control-text-color: #666; }
html { color: rgb(51, 51, 51); background: rgb(255, 255, 255); text-size-adjust: 100%; text-rendering: optimizeLegibility; font-size: 14px; -webkit-font-smoothing: initial; }
#write { max-width: 960px; padding-top: 2em; padding-left: 60px; padding-right: 60px; min-height: calc(100vh - 6em); -webkit-font-smoothing: antialiased; font-size: 16px; }
.typora-node #write { min-height: calc(100% - 6em); }
pre.md-meta-block { background: rgb(245, 245, 245); padding: 1em; border-radius: 3px; font-size: 14px; }
@media screen and (max-width: 800px) {
  html { font-size: 14px; }
  #write { padding-left: 30px; padding-right: 30px; font-size: 14px; }
}
@media screen and (min-width: 1100px) {
  body, #footer-word-count-info { background: rgb(245, 245, 245); }
  body.pin-outline, .pin-outline #footer-word-count-info, .pin-outline footer { background: rgb(255, 255, 255); }
  #write { max-width: 1000px; padding: 40px 60px; background: rgb(255, 255, 255); margin: 3em auto; border-style: solid; border-color: rgb(221, 221, 221); border-image: initial; border-width: 0px 1px; }
  .pin-outline #write { max-width: 1000px; background: rgb(255, 255, 255); margin: 0px; border: 0px; padding-left: 60px; padding-right: 60px; }
  footer { background-color: transparent; }
}
@media screen and (min-width: 1300px) {
  body.pin-outline, .pin-outline #footer-word-count-info, .pin-outline footer { background: rgb(245, 245, 245); }
  .pin-outline #write { max-width: 1000px; padding: 40px 60px; background: rgb(255, 255, 255); margin: 3em auto; border-style: solid; border-color: rgb(221, 221, 221); border-image: initial; border-width: 0px 1px; }
  .pin-outline footer { background-color: transparent; }
  #footer-word-count-info { background: rgb(245, 245, 245); }
}
html.borderbox *, html.borderbox ::before, html.borderbox ::after { box-sizing: border-box; }
body, dl, dt, dd, ul, ol, li, h1, h2, h3, h4, h5, h6, code, form, fieldset, legend, input, textarea, p, blockquote, th, td, hr, button, article, aside, details, figcaption, figure, footer, header, menu, nav, section { margin: 0px; padding: 0px; }
article, aside, details, figcaption, figure, footer, header, menu, nav, section { display: block; }
audio, canvas, video { display: inline-block; }
body, button, input, select, textarea { font-style: normal; font-variant: normal; font-weight: 300; font-stretch: normal; font-size: 1em; line-height: 1.8; font-family: "PingFang SC", "Lantinghei SC", "Microsoft Yahei", "Hiragino Sans GB", "Microsoft Sans Serif", "WenQuanYi Micro Hei", sans; }
body { font-family: "PingFang SC", "Lantinghei SC", "Microsoft Yahei", "Hiragino Sans GB", "Microsoft Sans Serif", "WenQuanYi Micro Hei", sans; }
h1, h2, h3, h4, h5, h6 { font-family: TimesNewRomanPS-ItalicMT, "PingFang SC", "Lantinghei SC", "Microsoft Yahei", "Hiragino Sans GB", "Microsoft Sans Serif", "WenQuanYi Micro Hei", sans; -webkit-font-smoothing: initial; font-weight: 100; color: var(--text-color); line-height: 1.35; font-variant-numeric: lining-nums; margin-bottom: 1em; }
em { font-family: Georgia-Italic, STSongti-SC-Light, serif; }
strong em, em strong { font-family: Georgia-BoldItalic, STSongti-SC-Regular, serif; }
table { border-collapse: collapse; border-spacing: 0px; }
fieldset, img { border: 0px; }
blockquote { position: relative; color: rgb(153, 153, 153); font-weight: 400; border-left: 1px solid rgb(26, 188, 156); padding-left: 1em; margin: 1em 3em 1em 2em; }
@media only screen and (max-width: 640px) {
  blockquote { margin: 1em 0px; }
}
acronym, abbr { border-bottom: 1px dotted; font-variant: normal; }
abbr { cursor: help; }
address, caption, cite, code, dfn, th, var { font-style: normal; font-weight: 400; }
ul, ol { list-style: none; }
caption, th { text-align: left; }
q::before, q::after { content: ""; }
sub, sup { font-size: 75%; line-height: 0; position: relative; }
:root sub, :root sup { vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
a { color: rgb(26, 188, 156); }
a:hover { text-decoration: underline; }
#write a { border-bottom: 1px solid rgb(26, 188, 156); }
#write a:hover { border-bottom-color: rgb(85, 85, 85); color: rgb(85, 85, 85); text-decoration: none; }
ins, a { text-decoration: none; }
mark { background: rgb(255, 253, 209); border-bottom: 1px solid rgb(255, 237, 206); padding: 2px; margin: 0px 5px; }
pre, code, pre tt { font-family: Courier, "Courier New", monospace; }
#write .md-fences { border: 1px solid rgb(221, 221, 221); padding: 1em 0.5em; display: block; }
hr { border-top: none; border-right: none; border-left: none; border-image: initial; border-bottom: 1px solid rgb(207, 207, 207); margin-bottom: 0.8em; height: 10px; }
#write strong { font-weight: 900; color: rgb(56, 56, 56); }
.code-tooltip.md-hover-tip strong { color: white; }
#write p, #write .md-fences, #write ul, #write ol, #write dl, #write form, #write hr, #write figure, #write-p, #write-pre, #write-ul, #write-ol, #write-dl, #write-form, #write-hr, #write-table, blockquote { margin-bottom: 1.2em; }
html { font-family: "PingFang SC", Verdana, "Helvetica Neue", "Microsoft Yahei", "Hiragino Sans GB", "Microsoft Sans Serif", "WenQuanYi Micro Hei", sans-serif; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write-h1, #write-h2, #write-h3, #write-h4, #write-h5, #write-h6 { margin-top: 1.2em; margin-bottom: 0.6em; line-height: 1.35; color: rgb(0, 0, 0); }
#write h1, #write-h1 { font-size: 2.4em; padding-bottom: 1em; border-bottom: 3px double rgb(238, 238, 238); }
#write h2, #write-h2 { font-size: 1.8em; }
#write h3, #write-h3 { font-size: 1.6em; }
#write h4, #write-h4 { font-size: 1.4em; }
#write h5, #write h6, #write-h5, #write-h6 { font-size: 1.2em; }
#write ul, #write-ul { margin-left: 1.3em; list-style: disc; }
#write ol, #write-ol { list-style: decimal; margin-left: 1.9em; }
#write li ul, #write li ol, #write-ul ul, #write-ul ol, #write-ol ul, #write-ol ol { margin-bottom: 0.8em; margin-left: 2em; }
#write li ul, #write-ul ul, #write-ol ul { list-style: circle; }
#write table th, #write table td { border: 1px solid rgb(221, 221, 221); padding: 0.5em 1em; color: rgb(102, 102, 102); }
#write table .md-table-edit th { border: none; padding: 0px; color: inherit; }
#write table th, #write-table th { background: rgb(251, 251, 251); }
#write table thead th, #write-table thead th { background: rgb(241, 241, 241); }
#write table caption { border-bottom: none; }
#write em { font-weight: inherit; font-style: inherit; }
li > p { margin-bottom: 0px !important; }
#write img { max-width: 100%; }
a.md-toc-inner { border-bottom: 0px !important; }
.md-toc-h1:first-of-type:last-of-type { display: none; }
.md-toc { font-size: inherit; }
.md-toc-h1 .md-toc-inner { font-weight: normal; }
.md-table-edit th { padding: 0px !important; border: 0px !important; }
.mac-seamless-mode #write { min-height: calc((100vh - 6em) - 20px); }
.typora-quick-open-item.active { color: var(--active-file-text-color); }
.in-text-selection, ::selection { background: var(--active-file-bg-color); text-shadow: none; color: white; }
.btn-primary { background-color: rgb(45, 45, 45); border-color: rgb(2, 2, 2); }
.btn-primary:hover, .btn-primary:focus, .btn-primary.focus, .btn-primary:active, .btn-primary.active, .open > .dropdown-toggle.btn-primary { background-color: rgb(78, 76, 78); border: rgb(78, 76, 78); }
#preference-dialog .modal-content { background: rgb(110, 117, 122); --bg-color: #6e757a; --text-color: #f1f1f1; color: rgb(241, 241, 241); }
#typora-source, .typora-sourceview-on { --bg-color: #eee; background: rgb(238, 238, 238); }
.cm-s-typora-default .cm-header, .cm-s-typora-default .cm-property { color: rgb(17, 96, 152); }
.cm-s-typora-default .cm-link { color: rgb(17, 152, 125); }
.cm-s-typora-default .cm-em { font-family: Georgia-Italic, STSongti-SC-Light, serif; color: rgb(111, 100, 0); }
.cm-s-typora-default .cm-em { color: rgb(0, 22, 45); }
.CodeMirror.cm-s-typora-default div.CodeMirror-cursor { border-left: 3px solid rgb(110, 117, 122); }
.cm-s-typora-default .CodeMirror-selectedtext, .typora-sourceview-on .CodeMirror-focused .CodeMirror-selected { background: rgb(110, 117, 122); color: white; }
.file-node-icon.fa.fa-folder::before { color: rgba(32, 43, 51, 0.49); }
#preference-dialog .megamenu-menu-panel h1 { margin-bottom: 1em; }
::-webkit-scrollbar-corner { display: none; background: transparent; }
.cm-s-inner { background-color: rgb(38, 50, 56); color: rgb(233, 237, 237); }
.cm-s-inner .CodeMirror-gutters { background: rgb(38, 50, 56); color: rgb(83, 127, 126); border: none; }
.cm-s-inner .CodeMirror-guttermarker, .cm-s-inner .CodeMirror-guttermarker-subtle, .cm-s-inner .CodeMirror-linenumber { color: rgb(83, 127, 126); }
.cm-s-inner .CodeMirror-cursor { border-left: 1px solid rgb(248, 248, 240); }
.cm-s-inner div.CodeMirror-selected { background: rgba(255, 255, 255, 0.15); }
.cm-s-inner.CodeMirror-focused div.CodeMirror-selected { background: rgba(255, 255, 255, 0.1); }
.cm-s-inner .CodeMirror-line::selection, .cm-s-inner .CodeMirror-line > span::selection, .cm-s-inner .CodeMirror-line > span > span::selection { background: rgba(255, 255, 255, 0.1); }
.cm-s-inner .CodeMirror-activeline-background { background: rgba(0, 0, 0, 0); }
.cm-s-inner .cm-keyword { color: rgb(199, 146, 234); }
.cm-s-inner .cm-operator { color: rgb(233, 237, 237); }
.cm-s-inner .cm-variable-2 { color: rgb(128, 203, 196); }
.cm-s-inner .cm-variable-3 { color: rgb(130, 177, 255); }
.cm-s-inner .cm-builtin { color: rgb(222, 203, 107); }
.cm-s-inner .cm-atom { color: rgb(247, 118, 105); }
.cm-s-inner .cm-number { color: rgb(247, 118, 105); }
.cm-s-inner .cm-def { color: rgb(233, 237, 237); }
.cm-s-inner .cm-string { color: rgb(195, 232, 141); }
.cm-s-inner .cm-string-2 { color: rgb(128, 203, 196); }
.cm-s-inner .cm-comment { color: rgb(84, 110, 122); }
.cm-s-inner .cm-variable { color: rgb(130, 177, 255); }
.cm-s-inner .cm-tag { color: rgb(128, 203, 196); }
.cm-s-inner .cm-meta { color: rgb(128, 203, 196); }
.cm-s-inner .cm-attribute { color: rgb(255, 203, 107); }
.cm-s-inner .cm-property { color: rgb(128, 203, 174); }
.cm-s-inner .cm-qualifier { color: rgb(222, 203, 107); }
.cm-s-inner .cm-variable-3 { color: rgb(222, 203, 107); }
.cm-s-inner .cm-tag { color: rgb(255, 83, 112); }
.cm-s-inner .cm-error { color: rgb(255, 255, 255); background-color: rgb(236, 95, 103); }
.cm-s-inner .CodeMirror-matchingbracket { text-decoration: underline; color: white !important; }
.md-fences { background-color: rgb(38, 50, 56); color: rgb(233, 237, 237); border: none; }
.md-fences .code-tooltip { background-color: rgb(38, 50, 56); }






</style>
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node'><div class='md-toc' mdtype='toc'><p class="md-toc-content"><span class="md-toc-item md-toc-h2" data-ref="n3"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n3">内存泄露排查</a></span><span class="md-toc-item md-toc-h3" data-ref="n4"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n4">OOM 导致被杀</a></span><span class="md-toc-item md-toc-h3" data-ref="n7"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n7">较为明显的内存泄漏</a></span><span class="md-toc-item md-toc-h3" data-ref="n21"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n21">不太明显的内存泄漏</a></span><span class="md-toc-item md-toc-h2" data-ref="n27"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n27">进程异常排查</a></span><span class="md-toc-item md-toc-h3" data-ref="n28"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n28">查看系统级别是否运行异常</a></span><span class="md-toc-item md-toc-h3" data-ref="n45"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n45">测试 TCP/UDP 端口连通性</a></span><span class="md-toc-item md-toc-h3" data-ref="n55"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n55">查看进程级别是否运行异常</a></span><span class="md-toc-item md-toc-h2" data-ref="n78"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n78">进程后台运行</a></span><span class="md-toc-item md-toc-h2" data-ref="n90"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n90">TCP 协议</a></span><span class="md-toc-item md-toc-h3" data-ref="n91"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n91">TCP 连接建立</a></span><span class="md-toc-item md-toc-h3" data-ref="n103"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n103">TCP 连接释放</a></span><span class="md-toc-item md-toc-h2" data-ref="n112"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n112">HTTP 压力测试</a></span><span class="md-toc-item md-toc-h3" data-ref="n113"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n113">wrk</a></span><span class="md-toc-item md-toc-h4" data-ref="n122"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n122">wrk的全局属性</a></span><span class="md-toc-item md-toc-h4" data-ref="n124"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n124">wrk 的全局方法</a></span><span class="md-toc-item md-toc-h4" data-ref="n126"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n126">启动阶段</a></span><span class="md-toc-item md-toc-h4" data-ref="n139"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n139">运行阶段</a></span><span class="md-toc-item md-toc-h4" data-ref="n151"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n151">结束阶段</a></span><span class="md-toc-item md-toc-h4" data-ref="n155"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n155">wrk 使用手册</a></span><span class="md-toc-item md-toc-h4" data-ref="n157"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n157">示例 1</a></span><span class="md-toc-item md-toc-h4" data-ref="n173"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n173">示例 2</a></span><span class="md-toc-item md-toc-h4" data-ref="n177"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n177">示例 3</a></span><span class="md-toc-item md-toc-h2" data-ref="n184"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n184">GDB 小技巧</a></span><span class="md-toc-item md-toc-h3" data-ref="n185"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n185">基本操作</a></span><span class="md-toc-item md-toc-h3" data-ref="n194"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n194">调试 coredump</a></span><span class="md-toc-item md-toc-h2" data-ref="n203"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n203">VIM 小技巧</a></span><span class="md-toc-item md-toc-h2" data-ref="n205"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n205">Git 小技巧</a></span><span class="md-toc-item md-toc-h3" data-ref="n206"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n206">基本操作</a></span><span class="md-toc-item md-toc-h3" data-ref="n208"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n208">git stash</a></span><span class="md-toc-item md-toc-h3" data-ref="n227"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n227">合并分支到主干</a></span><span class="md-toc-item md-toc-h3" data-ref="n229"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n229">查看历史提交信息</a></span><span class="md-toc-item md-toc-h3" data-ref="n231"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n231">仓库迁移</a></span><span class="md-toc-item md-toc-h3" data-ref="n233"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n233">合并多次提交</a></span><span class="md-toc-item md-toc-h3" data-ref="n242"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n242">github 同步 fork 仓库</a></span><span class="md-toc-item md-toc-h3" data-ref="n263"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n263">github 提交 PR</a></span><span class="md-toc-item md-toc-h2" data-ref="n281"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n281">同步机器时间、硬件时钟</a></span><span class="md-toc-item md-toc-h2" data-ref="n283"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n283">网络测速</a></span><span class="md-toc-item md-toc-h2" data-ref="n294"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n294">SSH 机器互信（免密登陆）</a></span><span class="md-toc-item md-toc-h2" data-ref="n309"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n309">PSSH 批量操作</a></span><span class="md-toc-item md-toc-h2" data-ref="n316"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n316">SSH 禁用超时</a></span><span class="md-toc-item md-toc-h2" data-ref="n338"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n338">跳板机 Jumpserver 上传/下载文件</a></span><span class="md-toc-item md-toc-h3" data-ref="n343"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n343">上传文件 rz</a></span><span class="md-toc-item md-toc-h3" data-ref="n345"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n345">下载文件 sz</a></span><span class="md-toc-item md-toc-h2" data-ref="n347"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n347">MySQL 小技巧</a></span><span class="md-toc-item md-toc-h3" data-ref="n348"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n348">MySQL 清理控制台</a></span><span class="md-toc-item md-toc-h3" data-ref="n350"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n350">MySQL 查看表结构</a></span><span class="md-toc-item md-toc-h3" data-ref="n354"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n354">MySQL 随机排序</a></span><span class="md-toc-item md-toc-h3" data-ref="n358"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n358">快捷选择 MySQL 实例</a></span><span class="md-toc-item md-toc-h3" data-ref="n369"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n369">条件插入</a></span><span class="md-toc-item md-toc-h3" data-ref="n373"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n373">timestamp 字段查询</a></span><span class="md-toc-item md-toc-h3" data-ref="n378"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n378">时间相关函数</a></span><span class="md-toc-item md-toc-h4" data-ref="n379"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n379">查询 utc 时间戳、utc 日期、utc 时间、now()</a></span><span class="md-toc-item md-toc-h4" data-ref="n381"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n381">now() 与 sysdate() 异同</a></span><span class="md-toc-item md-toc-h4" data-ref="n384"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n384">date_add 函数</a></span><span class="md-toc-item md-toc-h3" data-ref="n386"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n386">INSERT INTO SELECT 语句</a></span><span class="md-toc-item md-toc-h3" data-ref="n389"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n389">查看表创建时间</a></span><span class="md-toc-item md-toc-h3" data-ref="n392"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n392">三目表达式</a></span><span class="md-toc-item md-toc-h3" data-ref="n394"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n394">between ... and ...</a></span><span class="md-toc-item md-toc-h2" data-ref="n407"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n407">NGINX 基础配置</a></span><span class="md-toc-item md-toc-h3" data-ref="n408"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n408">配置静态资源</a></span><span class="md-toc-item md-toc-h4" data-ref="n409"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n409">使用 alias 重定义路径</a></span><span class="md-toc-item md-toc-h4" data-ref="n416"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n416">使用 root 指定前缀</a></span><span class="md-toc-item md-toc-h3" data-ref="n423"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n423">Location 匹配规则</a></span><span class="md-toc-item md-toc-h4" data-ref="n424"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n424">语法规则</a></span><span class="md-toc-item md-toc-h4" data-ref="n436"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n436">匹配过程</a></span><span class="md-toc-item md-toc-h4" data-ref="n451"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n451">示例详解</a></span><span class="md-toc-item md-toc-h4" data-ref="n459"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n459">location @name 使用</a></span><span class="md-toc-item md-toc-h4" data-ref="n466"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n466">URL 尾部的 <code>/</code></a></span><span class="md-toc-item md-toc-h4" data-ref="n472"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n472">配置静态资源</a></span><span class="md-toc-item md-toc-h4" data-ref="n476"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n476">实践原则</a></span><span class="md-toc-item md-toc-h4" data-ref="n484"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n484">参考资料</a></span><span class="md-toc-item md-toc-h2" data-ref="n492"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n492">NGINX 性能优化</a></span><span class="md-toc-item md-toc-h3" data-ref="n497"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n497">高层的配置</a></span><span class="md-toc-item md-toc-h3" data-ref="n510"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n510">Events 模块</a></span><span class="md-toc-item md-toc-h2" data-ref="n528"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n528">LINUX 内核调优参数</a></span><span class="md-toc-item md-toc-h3" data-ref="n531"><a class="md-toc-inner" style="cursor: pointer;" href="#header-n531">网络</a></span></p></div><hr /><h2><a name='header-n3' class='md-header-anchor '></a>内存泄露排查</h2><h3><a name='header-n4' class='md-header-anchor '></a>OOM 导致被杀</h3><p>利用 <code>dmesg</code> 查看</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dmesg | <span class="cm-builtin">grep</span> a.out</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><h3><a name='header-n7' class='md-header-anchor '></a>较为明显的内存泄漏</h3><blockquote><p>通过系统自带的命令持续地观察进程内存的占用情况，即可发现有明显内存泄漏的进程；更进一步，当进程运行一段时间导致系统内存耗尽，将会被操作系统杀掉。</p></blockquote><ul><li>利用 <code>free</code> 查看系统内存</li><li>利用 <code>top</code>/<code>htop</code> 查看进程占用内存</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">top</span> <span class="cm-attribute">-d</span> <span class="cm-number">1</span> <span class="cm-attribute">-p</span> pid</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><ul><li>利用 ps 查看进程占用内存</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">watch <span class="cm-attribute">-n1</span> <span class="cm-string">'ps -aux|grep -v grep|grep pid'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><h3><a name='header-n21' class='md-header-anchor '></a>不太明显的内存泄漏</h3><ul><li>利用 <code>valgrind</code> 工具查看内存分配、释放、泄漏</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">valgrind <span class="cm-attribute">--log-file</span><span class="cm-operator">=</span>valgrind.log <span class="cm-attribute">--tool</span><span class="cm-operator">=</span>memcheck <span class="cm-attribute">--leak-check</span><span class="cm-operator">=</span>full <span class="cm-attribute">--show-reachable</span><span class="cm-operator">=</span>no <span class="cm-attribute">--workaround-gcc296-bugs</span><span class="cm-operator">=</span><span class="cm-builtin">yes</span> ./a.out</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><h2><a name='header-n27' class='md-header-anchor '></a>进程异常排查</h2><h3><a name='header-n28' class='md-header-anchor '></a>查看系统级别是否运行异常</h3><ul><li>利用 <code>top</code>/<code>htop</code> 查看全局资源使用</li><li>利用 <code>free</code> 查看系统内存使用</li><li>利用 <code>iostat</code> 查看磁盘 <code>I/O</code> 是否异常</li><li>利用 <code>df -i</code> 查看系统 <code>inode</code> 使用是否异常；<code>df -h</code> 查看系统磁盘使用是否异常</li><li>利用 <code>ss</code>/<code>netstat</code> 查看系统网络连接是否异常</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看网络统计信息</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">root@:~<span class="cm-comment"># netstat -s|grep -E "rejects|overflowed|timeout|dropped"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">6</span> dropped because of missing route</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">479629</span> times the listen queue of a socket overflowed</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">482420</span> SYNs to LISTEN sockets dropped</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">5</span> timeouts after SACK recovery</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">2</span> timeouts <span class="cm-keyword">in</span> loss state</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">12200</span> other TCP timeouts</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-number">582</span> connections aborted due to timeout</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看网络连接信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">root@:~<span class="cm-comment"># netstat -nap</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Active Internet connections (servers and established)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Proto Recv-Q Send-Q Local Address &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Foreign Address &nbsp; &nbsp; &nbsp; &nbsp; State &nbsp; &nbsp; &nbsp; PID/Program name</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">0</span>.0.0.0:4501 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span>.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;<span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">0</span>.0.0.0:22 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span>.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;<span class="cm-number">907</span>/sshd &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">0</span>.0.0.0:7901 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span>.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;<span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">127</span>.0.0.1:32000 &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">0</span>.0.0.0:* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LISTEN &nbsp; &nbsp; &nbsp;<span class="cm-number">1688</span>/java &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:7901 &nbsp; &nbsp; &nbsp;<span class="cm-number">47</span>.104.240.30:49308 &nbsp; &nbsp; ESTABLISHED <span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:7901 &nbsp; &nbsp; &nbsp;<span class="cm-number">39</span>.104.158.97:54688 &nbsp; &nbsp; ESTABLISHED <span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:7901 &nbsp; &nbsp; &nbsp;<span class="cm-number">47</span>.99.132.207:56138 &nbsp; &nbsp; ESTABLISHED <span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:22 &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">219</span>.133.101.96:42080 &nbsp;  ESTABLISHED <span class="cm-number">9831</span>/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:58788 &nbsp; &nbsp; <span class="cm-number">47</span>.104.240.30:7901 &nbsp; &nbsp;  ESTABLISHED <span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:58600 &nbsp; &nbsp; <span class="cm-number">47</span>.99.132.207:7901 &nbsp; &nbsp;  ESTABLISHED <span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:7901 &nbsp; &nbsp; &nbsp;<span class="cm-number">39</span>.106.164.24:59070 &nbsp; &nbsp; ESTABLISHED <span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:58122 &nbsp; &nbsp; <span class="cm-number">106</span>.11.248.209:80 &nbsp; &nbsp; &nbsp; ESTABLISHED <span class="cm-number">1287</span>/AliYunDun &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; <span class="cm-number">32</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:43932 &nbsp; &nbsp; <span class="cm-number">100</span>.100.0.13:3128 &nbsp; &nbsp; &nbsp; CLOSE_WAIT &nbsp;<span class="cm-number">1688</span>/java &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:7901 &nbsp; &nbsp; &nbsp;<span class="cm-number">47</span>.104.229.53:46200 &nbsp; &nbsp; ESTABLISHED <span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">127</span>.0.0.1:32000 &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-number">127</span>.0.0.1:31000 &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED <span class="cm-number">1686</span>/wrapper &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:7901 &nbsp; &nbsp; &nbsp;<span class="cm-number">116</span>.62.67.116:59758 &nbsp; &nbsp; ESTABLISHED <span class="cm-number">25511</span>/coind &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> &nbsp; &nbsp; &nbsp;<span class="cm-number">0</span> <span class="cm-number">172</span>.18.219.68:58226 &nbsp; &nbsp; <span class="cm-number">106</span>.14.112.174:7901 &nbsp; &nbsp; ESTABLISHED <span class="cm-number">25511</span>/coind </span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 682px;"></div><div class="CodeMirror-gutters" style="display: none; height: 682px;"></div></div></div></pre><ul><li>利用 <code>ifstat</code> 查看系统网络流量是否异常</li></ul><h3><a name='header-n45' class='md-header-anchor '></a>测试 TCP/UDP 端口连通性</h3><ul><li>TCP</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">root@ubuntu:~<span class="cm-comment"># nc -z -v 192.168.1.175 22</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Connection to <span class="cm-number">192</span>.168.1.175 <span class="cm-number">22</span> port [tcp/ssh] succeeded!</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">root@ubuntu:~<span class="cm-comment"># telnet 192.168.1.175 22</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Trying <span class="cm-number">192</span>.168.1.175...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Connected to <span class="cm-number">192</span>.168.1.175.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Escape character is <span class="cm-string">'^]'</span>.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SSH-2.0-OpenSSH_6.6.1p1 Ubuntu-2ubuntu2.10</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><ul><li>UDP</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># nc -z -v -u 192.168.10.12 123</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Connection to <span class="cm-number">192</span>.118.20.95 <span class="cm-number">123</span> port [udp/ntp] succeeded!</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><h3><a name='header-n55' class='md-header-anchor '></a>查看进程级别是否运行异常</h3><ul><li><code>top</code>/<code>htop</code> 查看进程资源使用是否正常（特别注意，内存是否一致在增加）</li><li><code>lsof</code> 查看进程打开的文件句柄数</li><li>查看进程堆栈信息（2388 为进程号）</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@www ~]<span class="cm-comment"># cat /proc/2388/stack</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[&lt;ffffffff811f2bb5&gt;] poll_schedule_timeout<span class="cm-operator">+</span>0x55/0xb0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[&lt;ffffffff811f413d&gt;] do_sys_poll<span class="cm-operator">+</span>0x4cd/0x580</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[&lt;ffffffff811f42f4&gt;] SyS_poll<span class="cm-operator">+</span>0x74/0x110</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[&lt;ffffffff81645909&gt;] system_call_fastpath<span class="cm-operator">+</span>0x16/0x1b</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><ul><li><code>strace</code> 查看系统调用和信号</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@www ~]<span class="cm-comment">#  strace -s 99 -ffp 3363</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Process <span class="cm-number">3363</span> attached with <span class="cm-number">2</span> threads</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[pid &nbsp;<span class="cm-number">3365</span>] restart_syscall(&lt;... resuming interrupted call ...&gt; &lt;unfinished ...&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[pid &nbsp;<span class="cm-number">3363</span>] select(18, [13 <span class="cm-number">16</span> <span class="cm-number">17</span>], NULL, NULL, {29, <span class="cm-number">702368</span>}) <span class="cm-operator">=</span> <span class="cm-number">1</span> (in [16], left {23, <span class="cm-number">709762</span>})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[pid &nbsp;<span class="cm-number">3363</span>] fcntl(16, F_GETFL) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">=</span> 0x802 (flags O_RDWR|O_NONBLOCK)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[pid &nbsp;<span class="cm-number">3363</span>] accept4(16, <span class="cm-number">0</span>, NULL, SOCK_CLOEXEC) <span class="cm-operator">=</span> <span class="cm-attribute">-1</span> EAGAIN (Resource temporarily unavailable)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Process <span class="cm-number">3365</span> detached</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 154px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><ul><li><code>gdb attach</code> 进程并获取堆栈信息</li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">[root@www ~]<span class="cm-comment"># gdb attach 2388</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">GNU gdb (GDB) Red Hat Enterprise Linux <span class="cm-number">7</span>.6.1-80.el7</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Copyright (C) <span class="cm-number">2013</span> Free Software Foundation, Inc.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">License GPLv3<span class="cm-operator">+</span>: GNU GPL version <span class="cm-number">3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">This is free software: you are free to change and redistribute it.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">There is NO WARRANTY, to the extent permitted by law.  Type <span class="cm-string">"show copying"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">and <span class="cm-string">"show warranty"</span> <span class="cm-keyword">for</span> details.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">This GDB was configured as <span class="cm-string">"x86_64-redhat-linux-gnu"</span>.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">For bug reporting instructions, please see:</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Attaching to process <span class="cm-number">2388</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Reading symbols from /home/mysql/bin/mysqld...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">done</span>.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Reading symbols from /usr/lib64/libpthread.so.0...Reading symbols from /usr/lib/debug/usr/lib64/libpthread-2.17.so.debug...done.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">done</span>.</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(gdb) </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">(gdb) bt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#0  0x00007f88e3f4669d in poll () at ../sysdeps/unix/syscall-template.S:81</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#1  0x0000000000d2ae9d in Mysqld_socket_listener::listen_for_connection_event (this=0x5933700)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  at /root/lnmp1.3-full/src/mysql-5.7.11/sql/conn_handler/socket_connection.cc:848</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#2  0x000000000077e069 in connection_event_loop (this=0x59a6050) at /root/lnmp1.3-full/src/mysql-5.7.11/sql/conn_handler/connection_acceptor.h:66</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#3  mysqld_main (argc=45, argv=0x3b56bd8) at /root/lnmp1.3-full/src/mysql-5.7.11/sql/mysqld.cc:4941</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#4  0x00007f88e3e7bb15 in __libc_start_main (main=0x756100 &lt;main(int, char**)&gt;, argc=10, ubp_av=0x7ffe5ab6c418, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-def">rtld_fini</span><span class="cm-operator">=</span>&lt;optimized out&gt;, <span class="cm-def">stack_end</span><span class="cm-operator">=</span>0x7ffe5ab6c408) at libc-start.c:274</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#5  0x00000000007734dd in _start ()</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 638px;"></div><div class="CodeMirror-gutters" style="display: none; height: 638px;"></div></div></div></pre><ul><li>java 程序，可以借助 <code>jstack</code>、<code>jstat</code>、<code>jmap</code>、<code>jinfo</code> 等查看进程的运行信息</li></ul><h2><a name='header-n78' class='md-header-anchor '></a>进程后台运行</h2><ul><li>代码层面，不同语言均可调用系统接口 daemon() 去实现</li><li>damon/damonlize 等小工具（不同系统名字略有不同）</li><li>screen/tmux</li><li>nohup</li><li>systemd/supervisor</li></ul><h2><a name='header-n90' class='md-header-anchor '></a>TCP 协议</h2><h3><a name='header-n91' class='md-header-anchor '></a>TCP 连接建立</h3><p>在 TCP/IP 协议中，TCP 协议提供可靠的连接服务，采用三次握手建立一个连接。</p><ul><li>第一次握手：建立连接时，客户端发送 <code>SYN</code> 到服务器，并进入 <code>SYN_SEND</code> 状态，等待服务器确认</li><li>第二次握手：服务器收到 <code>SYN</code>，必须确认客户的 <code>SYN</code>，同时自己也发送一个 <code>SYN</code>，即 <code>SYN + ACK</code>，此时服务器 进入 <code>SYN_RECV</code> 状态</li><li>第三次握手：客户端收到服务器的 <code>SYN＋ACK</code>，向服务器发送确认包 <code>ACK</code>，此包发送完毕，客户端和服务器进入 <code>ESTABLISHED</code> 状态，完成三次握手。 完成三次握手，客户端与服务器开始传送数据。</li></ul><p><img src='pic/tcp/connect.png' alt='' referrerPolicy='no-referrer' /></p><p><strong>为什么要三次握手？</strong></p><p>防止失效的连接请求突然传到服务器端，让服务器端误认为要建立连接。</p><h3><a name='header-n103' class='md-header-anchor '></a>TCP 连接释放</h3><p>在 TCP/IP 协议中，TCP 协议提供可靠的连接服务，采用四次挥手释放一个连接。</p><p><img src='pic/tcp/disconnect.png' alt='' referrerPolicy='no-referrer' /></p><p><strong>为什么 Client 进入 TIME-WAIT 后必须等待 2 MSL？</strong></p><ul><li>保证 Client 发送的最后一个 ACK 报文段能达到 Server</li><li>防止失效的报文段出现在连接中</li></ul><h2><a name='header-n112' class='md-header-anchor '></a>HTTP 压力测试</h2><h3><a name='header-n113' class='md-header-anchor '></a>wrk</h3><ul><li>wrk 是一款现代化的 http 压测工具，提供 lua 脚本的功能可以满足每个请求或部分请求的差异化</li><li>wrk 中执行 http 请求的时候，调用 lua 分为3个阶段，setup，running，done，每个 wrk 线程中都有独立的脚本环境</li><li>可以参考 <a href='https://github.com/wg/wrk'>wrk benchmark</a> 项目包含的样例（目录 scripts）以及说明（SCRIPTING）</li></ul><p><img src='pic/wrk/wrk.png' alt='' referrerPolicy='no-referrer' /></p><h4><a name='header-n122' class='md-header-anchor '></a>wrk的全局属性</h4><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">wrk</span> = {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">scheme</span>  = <span class="cm-string">"http"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">host</span> &nbsp;  = <span class="cm-string">"localhost"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">port</span> &nbsp;  = <span class="cm-keyword">nil</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">method</span>  = <span class="cm-string">"GET"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">path</span> &nbsp;  = <span class="cm-string">"/"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">headers</span> = {},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">body</span> &nbsp;  = <span class="cm-keyword">nil</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">thread</span>  = &lt;<span class="cm-variable">userdata</span>&gt;,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><h4><a name='header-n124' class='md-header-anchor '></a>wrk 的全局方法</h4><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 生成整个 request 的 string，与全局属性 wrk table 配合使用</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">wrk.format</span>(<span class="cm-variable">method</span>, <span class="cm-variable">path</span>, <span class="cm-variable">headers</span>, <span class="cm-variable">body</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 获取域名的 IP 和端口，返回 table</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">wrk.lookup</span>(<span class="cm-variable">host</span>, <span class="cm-variable">service</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 判断 addr 是否能连接，例如：`127.0.0.1:80`，返回 true 或 false</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">wrk.connect</span>(<span class="cm-variable">addr</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><h4><a name='header-n126' class='md-header-anchor '></a>启动阶段</h4><blockquote><p>在脚本文件中实现 setup 方法，wrk 就会在测试线程已经初始化但还没有启动的时候调用该方法。wrk 会为每一个测试线程调用一次 setup 方法，并传入代表测试线程的对象 thread 作为参数。setup 方法中可操作该thread 对象，获取信息、存储信息、甚至关闭该线程。 </p></blockquote><p>thread提供了 1 个属性，3 个方法 </p><ul><li>thread.addr 设置请求需要打到的 ip</li><li>thread:get(name) 获取线程全局变量</li><li>thread:set(name, value) 设置线程全局变量</li><li>thread:stop() 终止线程</li></ul><h4><a name='header-n139' class='md-header-anchor '></a>运行阶段</h4><blockquote><p>init 由测试线程调用，只会在进入运行阶段时，调用一次。支持从启动 wrk 的命令中，获取命令行参数； delay 在每次发送 request 之前调用，如果需要 delay，那么 delay 相应时间； request 用来生成请求；每一次请求都会调用该方法，所以注意不要在该方法中做耗时的操作； reponse 在每次收到一个响应时调用；为提升性能，如果没有定义该方法，那么 wrk 不会解析 headers 和 body。</p></blockquote><ul><li>function init(args)  每个线程仅调用 1 次，args 用于获取命令行中传入的参数, 例如 --env=pre</li><li>function delay()  每次请求调用 1 次，发送下一个请求之前的延迟, 单位为 ms </li><li>function request()  每次请求调用 1 次，返回 http 请求  </li><li>function response(status, headers, body)  每次请求调用 1 次，返回 http 响应</li></ul><h4><a name='header-n151' class='md-header-anchor '></a>结束阶段</h4><blockquote><p>该方法在整个测试过程中只会调用一次，可从参数给定的对象中，获取压测结果，生成定制化的测试报告。 </p></blockquote><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">function</span> <span class="cm-variable">done</span>(<span class="cm-variable">summary</span>, <span class="cm-variable">latency</span>, <span class="cm-variable">requests</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">latency.min</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- minimum value seen</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">latency.max</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- maximum value seen</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">latency.mean</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">-- average value seen</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">latency.stdev</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">-- standard deviation</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">latency</span>:<span class="cm-variable">percentile</span>(<span class="cm-number">99.0</span>) <span class="cm-comment">-- 99th percentile value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">latency</span>(<span class="cm-variable">i</span>) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">-- raw value and count</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">summary</span> = {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">duration</span> = <span class="cm-variable">N</span>, &nbsp;<span class="cm-comment">-- run duration in microseconds</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">requests</span> = <span class="cm-variable">N</span>, &nbsp;<span class="cm-comment">-- total completed requests</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">bytes</span> &nbsp;  = <span class="cm-variable">N</span>, &nbsp;<span class="cm-comment">-- total bytes received</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-variable">errors</span> &nbsp; = {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">connect</span> = <span class="cm-variable">N</span>, <span class="cm-comment">-- total socket connection errors</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">read</span> &nbsp;  = <span class="cm-variable">N</span>, <span class="cm-comment">-- total socket read errors</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-builtin">write</span> &nbsp; = <span class="cm-variable">N</span>, <span class="cm-comment">-- total socket write errors</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">status</span>  = <span class="cm-variable">N</span>, <span class="cm-comment">-- total HTTP status codes &gt; 399</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">timeout</span> = <span class="cm-variable">N</span> &nbsp;<span class="cm-comment">-- total request timeouts</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 484px;"></div><div class="CodeMirror-gutters" style="display: none; height: 484px;"></div></div></div></pre><h4><a name='header-n155' class='md-header-anchor '></a>wrk 使用手册</h4><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">使用方法: wrk &lt;选项&gt; &lt;被测 HTTP 服务的 URL&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  Options: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-attribute">-c</span>, <span class="cm-attribute">--connections</span> &lt;N&gt;  跟服务器建立并保持的 TCP 连接数量 &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-attribute">-d</span>, <span class="cm-attribute">--duration</span> &nbsp;  &lt;T&gt;  压测时间 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-attribute">-t</span>, <span class="cm-attribute">--threads</span> &nbsp; &nbsp; &lt;N&gt;  使用多少个线程进行压测 &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-attribute">-s</span>, <span class="cm-attribute">--script</span> &nbsp; &nbsp;  &lt;S&gt;  指定 Lua 脚本路径 &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-attribute">-H</span>, <span class="cm-attribute">--header</span> &nbsp; &nbsp;  &lt;H&gt;  为每一个 HTTP 请求添加 HTTP 头 &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--latency</span> &nbsp; &nbsp; &nbsp; &nbsp;  在压测结束后，打印延迟统计信息 &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">--timeout</span> &nbsp; &nbsp; &lt;T&gt;  超时时间 &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-attribute">-v</span>, <span class="cm-attribute">--version</span> &nbsp; &nbsp; &nbsp; &nbsp;  打印正在使用的 wrk 的详细版本信息</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  &lt;N&gt;代表数字参数，支持国际单位 (1k, 1M, 1G)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  &lt;T&gt;代表时间参数，支持时间单位 (2s, 2m, 2h)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><h4><a name='header-n157' class='md-header-anchor '></a>示例 1</h4><blockquote><p>启动 4 个线程，创建 100 个连接，持续 10s，请求百度主页（<strong>支持 HTTP/HTTPS</strong>）</p></blockquote><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">root@ubuntu:~/wrk<span class="cm-comment"># wrk -t4 -c100 -d10s https://www.baidu.com</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Running 10s test @ https://www.baidu.com</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-number">4</span> threads and <span class="cm-number">100</span> connections</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  Thread Stats &nbsp; Avg &nbsp; &nbsp;  Stdev &nbsp; &nbsp; Max &nbsp; <span class="cm-operator">+</span>/- Stdev</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  Latency &nbsp; &nbsp;<span class="cm-number">77</span>.65ms &nbsp;<span class="cm-number">122</span>.51ms &nbsp; <span class="cm-number">1</span>.88s &nbsp; &nbsp;<span class="cm-number">88</span>.42%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  Req/Sec &nbsp; <span class="cm-number">618</span>.40 &nbsp; &nbsp;<span class="cm-number">200</span>.60 &nbsp; &nbsp; <span class="cm-number">1</span>.25k &nbsp; &nbsp;<span class="cm-number">77</span>.58%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-number">24500</span> requests <span class="cm-keyword">in</span> <span class="cm-number">10</span>.04s, <span class="cm-number">360</span>.47MB read</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  Socket errors: connect <span class="cm-number">0</span>, read <span class="cm-number">130</span>, <span class="cm-builtin">write</span> <span class="cm-number">0</span>, timeout <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Requests/sec: &nbsp; <span class="cm-number">2439</span>.09</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Transfer/sec: &nbsp; &nbsp; <span class="cm-number">35</span>.89MB</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><p><strong>结果分析：</strong></p><ul><li><code>avg/stddev/max</code> 平均值/标准差/最大值</li><li><code>+/- stddev</code> 正负一个标准差，落在正负一个标准差的次数所占比重，值越大数据越稳定</li><li><code>latency</code> 时延，对应响应时间</li><li><code>Req/Sec</code> 单个线程每秒钟请求数，值越大性能越高</li><li><code>Requests/sec</code> 所有线程总共平均每秒钟请求数</li></ul><h4><a name='header-n173' class='md-header-anchor '></a>示例 2</h4><blockquote><p>每个线程要先进行认证，认证之后获取 token 以进行压测。在没有token的情况下，先访问 /authenticate 认证。认证成功后，读取 token 并替换 path 为 /resource。</p></blockquote><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="lua" contenteditable="false" cid="n176" mdtype="fences" style="break-inside: unset;">token = nil
path  = "/authenticate"

request = function()
   return wrk.format("GET", path)
end

response = function(status, headers, body)
   if not token and status == 200 then
      token = headers["X-Token"]
      path  = "/resource"
      wrk.headers["X-Token"] = token
   end
end
</pre><h4><a name='header-n177' class='md-header-anchor '></a>示例 3</h4><blockquote><p>启动 4 个线程，创建 100 个连接，持续 10s，每个请求发送不同的数据</p></blockquote><p>脚本内容如下所示</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="lua" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="lua"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">wrk.method</span> = <span class="cm-string">"POST"</span> &nbsp;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">wrk.body</span> &nbsp; = <span class="cm-string">""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 可以根据实际接口请求路径修改</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">wrk.path</span> &nbsp; = <span class="cm-string">"/"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">wrk.headers</span>[<span class="cm-string">"Content-Type"</span>] = <span class="cm-string">"text/plain"</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 每次修改充值积分值，保证每次交易都能成功提交，否则，可能因为交易仍在内存池中，</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 判定为同一笔交易导致提交失败。当然，也可在脚本中每次选用不同的目标账户进行充值。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">value</span> = <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">a</span> = <span class="cm-string">'{\"jsonrpc\": \"1.0\", \"id\":\"curltest\", \"method\": \"creditrechargetx\", \"params\": [\"wWPAztEx3m5hArykWaH3qQZ13NtxaZXJts\", \"82908-1\", 0, 10000, 0, \"wNYc86E6JVvQfmgzQDESR81J7UuLtt9WDx\", '</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">local</span> <span class="cm-variable">b</span> = <span class="cm-string">'] }'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">request</span> = <span class="cm-keyword">function</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">local</span> <span class="cm-variable">data</span> = <span class="cm-builtin">string.format</span>(<span class="cm-string">"%s%d%s"</span>, <span class="cm-variable">a</span>, <span class="cm-variable">value</span>, <span class="cm-variable">b</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">value</span> = <span class="cm-variable">value</span> + <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">wrk.format</span>(<span class="cm-keyword">nil</span>, <span class="cm-keyword">nil</span>, <span class="cm-keyword">nil</span>, <span class="cm-variable">data</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 请求之间设置 30~40 ms 的随机延迟</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">--function delay()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- &nbsp; return math.random(30, 40)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">--end</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 可打印响应内容</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">--response = function(status, headers, body)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- &nbsp;  print(string.format("status: %d", status))</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- &nbsp;  print(body)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">--end</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 682px;"></div><div class="CodeMirror-gutters" style="display: none; height: 682px;"></div></div></div></pre><p>执行压测用例</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">root@ubuntu:~/wrk<span class="cm-comment"># wrk -t4 -c100 -d10s -s creditrecharge.lua http://192.168.1.213:6901</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Running 10s test @ http://192.168.1.213:6901</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-number">4</span> threads and <span class="cm-number">100</span> connections</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  Thread Stats &nbsp; Avg &nbsp; &nbsp;  Stdev &nbsp; &nbsp; Max &nbsp; <span class="cm-operator">+</span>/- Stdev</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  Latency &nbsp; <span class="cm-number">688</span>.24ms &nbsp;<span class="cm-number">363</span>.88ms &nbsp; <span class="cm-number">2</span>.00s &nbsp; &nbsp;<span class="cm-number">84</span>.39%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  Req/Sec &nbsp; &nbsp;<span class="cm-number">52</span>.32 &nbsp; &nbsp; <span class="cm-number">50</span>.44 &nbsp; <span class="cm-number">242</span>.00 &nbsp; &nbsp; <span class="cm-number">83</span>.33%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-number">1435</span> requests <span class="cm-keyword">in</span> <span class="cm-number">10</span>.09s, <span class="cm-number">667</span>.72KB read</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  Socket errors: connect <span class="cm-number">0</span>, read <span class="cm-number">0</span>, <span class="cm-builtin">write</span> <span class="cm-number">0</span>, timeout <span class="cm-number">15</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Requests/sec: &nbsp; &nbsp;<span class="cm-number">142</span>.25</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Transfer/sec: &nbsp; &nbsp; <span class="cm-number">66</span>.19KB</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><h2><a name='header-n184' class='md-header-anchor '></a>GDB 小技巧</h2><h3><a name='header-n185' class='md-header-anchor '></a>基本操作</h3><ul><li>基础</li></ul><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n189" mdtype="fences" style="break-inside: unset;"># 列出源码的一部分
list

# 单步调试，不进入函数
next
# 单步调试，进入函数
step

# 运行加载了的程序
run
# 继续执行程序
continue
# 退出调试
quit

# 输出特定变量的值
print
# 设置断点
break
# 查看所有断点信息
info breakpoints
# 删除断点
delete &lt;num&gt;

# 查看本地变量
info locals
# 查看 goroutine 列表（GoLang 专用）
info goroutines
# 查看所有的线程
info threads
# 切换到某个线程
thread &lt;线程号&gt;
# 查看当前变量的类型
whatis &lt;变量名&gt;

# 监视一个变量的值，一旦发生变化，程序将会被暂停
watch

# 改变运行过程中的变量值
set variable &lt;var&gt;=&lt;value&gt;

# 打印所有线程堆栈
thread apply all bt
</pre><ul><li>调整堆栈层级</li></ul><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n193" mdtype="fences">#0  __lll_lock_wait () at ../nptl/sysdeps/unix/sysv/linux/x86_64/lowlevellock.S:135
135     in ../nptl/sysdeps/unix/sysv/linux/x86_64/lowlevellock.S

# 进入上一层堆栈
(gdb) up
#1  0x00007f23cb9d2664 in _L_lock_952 () from /lib/x86_64-linux-gnu/libpthread.so.0
(gdb) up
#2  0x00007f23cb9d24c6 in __GI___pthread_mutex_lock (mutex=0x60adf38388 &lt;mempool+8&gt;) at ../nptl/pthread_mutex_lock.c:114
114     ../nptl/pthread_mutex_lock.c: No such file or directory.

# 进入下一层堆栈
(gdb) down
#1  0x00007f23cb9d2664 in _L_lock_952 () from /lib/x86_64-linux-gnu/libpthread.so.0
</pre><h3><a name='header-n194' class='md-header-anchor '></a>调试 coredump</h3><ul><li>生成 coredump 文件</li></ul><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n198" mdtype="fences"># 方式一
gcore -o xxx.core pid

# 方式二
gdb attach pid
gcore
</pre><ul><li>调试 coredump 文件</li></ul><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n202" mdtype="fences">gdb xxx -c xxx.core
</pre><h2><a name='header-n203' class='md-header-anchor '></a>VIM 小技巧</h2><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># VIM 替换时带确认，即，对于任何一个匹配项，需要确认是否替换</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:%s/a/b/gc</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 上下(垂直）分割当前打开的文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Ctrl<span class="cm-operator">+</span>w s</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 左右（水平）分割当前打开的文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Ctrl<span class="cm-operator">+</span>w v</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭当前窗口，对应 :close </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 注意：最后一个窗口不能使用 close 关闭，使用 close 只是暂时关闭窗口，其内容还在缓存中。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Ctrl<span class="cm-operator">+</span>w c</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭当前窗口，对应 :q</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Ctrl<span class="cm-operator">+</span>w q</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 横向切割窗口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:new 文件名</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:split 文件名 或简写为 :sp 文件名</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 纵向切割窗口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:vsplit 文件名 或简写为 :vsp 文件名</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭当前窗口，对应 :close，使用 close 只是暂时关闭窗口，其内容还在缓存中。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Ctrl<span class="cm-operator">+</span>w c</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭当前窗口，对应 :q，与 close 不同之处在于永久关闭窗口，因此可关闭最后一个打开的窗口。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Ctrl<span class="cm-operator">+</span>w q</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切换窗口：连续两次 Ctrl+w 依次切换打开的窗口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Ctrl<span class="cm-operator">+</span>w Ctrl<span class="cm-operator">+</span>w</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切换窗口：Ctrl+w 配合h/j/k/l 或者 上下左右方向键</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">Ctrl<span class="cm-operator">+</span>w h/j/k/l</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 显示空格、TAB</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># TAB&nbsp;键显示为&nbsp;^I，$ 显示在每行的结尾，表示换行；空格仍然显示为空格。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:set list<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-tab" role="presentation" cm-text="	">    </span>进入 List Mode</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:set nolist<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span>退出 List Mode</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 792px;"></div><div class="CodeMirror-gutters" style="display: none; height: 792px;"></div></div></div></pre><h2><a name='header-n205' class='md-header-anchor '></a>Git 小技巧</h2><h3><a name='header-n206' class='md-header-anchor '></a>基本操作</h3><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded md-focus" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap CodeMirror-focused" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 814px; left: 351.781px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 克隆远程仓库到本地</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> clone <span class="cm-builtin">ssh</span>://kevin@192.168.5.32:29418/dummy.git</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看本地变更信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> status</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看本地当前目录变更信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> status .</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加提交信息（交互式编辑）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加提交信息（非交互式）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">-m</span> <span class="cm-string">"fix(module): free memory"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 追加新的变更到上次提交（即，commit id 不变，多次修改的内容合并到一次提交）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">--amend</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 修改本次提交的作者信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">--amend</span> <span class="cm-attribute">--author</span><span class="cm-operator">=</span><span class="cm-string">"kevin &lt;dudebing99@gmail.com&gt;"</span> <span class="cm-attribute">-C</span> HEAD</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前所在分支</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> branch</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看远程分支</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> branch <span class="cm-attribute">-r</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看远程仓库地址</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> remote <span class="cm-attribute">-v</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 以远程分支或 tag 创建本地分支</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> checkout <span class="cm-attribute">-b</span> &lt;local branch&gt; &lt;remote branch OR tag&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 以某个分支强制覆盖本地分支并推送</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> reset <span class="cm-attribute">--hard</span> &lt;remote_branch&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push <span class="cm-attribute">-f</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切换 HEAD 指向的默认分支</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> remote set-head origin &lt;target_branch&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置当前分支的默认远程分支，git push 即可缺省推到远程分支</span></span></pre></div><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push <span class="cm-attribute">--set-upstream</span> origin &lt;target_branch&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 836px;"></div><div class="CodeMirror-gutters" style="display: none; height: 836px;"></div></div></div></pre><h3><a name='header-n208' class='md-header-anchor '></a>git stash</h3><p>默认情况下，git stash 缓存文件的策略如下：</p><p><strong>会缓存下列文件</strong></p><ul><li>添加到暂存区的修改（<code>staged changes</code>）</li><li>Git 跟踪的但并未添加到暂存区的修改（<code>unstaged changes</code>）</li></ul><p><strong>不会缓存以下文件</strong></p><ul><li>在工作目录中新的文件（<code>untracked files</code>）</li><li>被忽略的文件（<code>ignored files</code>）</li></ul><blockquote><p>使用 -u 或者 --include-untracked 可以 stash untracked 的文件</p></blockquote><blockquote><p>使用 -a 或者 --all 命令可以  stash 当前目录下的所有修改</p></blockquote><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保存未提交的变更(建议通过 sava "fix(xxx): xxx)" 备注变更说明）</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> stash save <span class="cm-string">"fix(xxx): xxx"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 可在 git stash 之后拉取远程最新代码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 然后，pop 之前保存的未提交的更新，做修改、合并，最后再提交</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> stash pop</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># pop 指定栈层次， git stash pop stash@{0} 命令等同于 git stash pop</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> stash pop stash@{id}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看所有的 stash</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> stash list</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 移除某个 stash</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> stash drop stash@{id}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 移除所有的 stash</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> stash <span class="cm-builtin">clear</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 374px;"></div><div class="CodeMirror-gutters" style="display: none; height: 374px;"></div></div></div></pre><h3><a name='header-n227' class='md-header-anchor '></a>合并分支到主干</h3><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 假设在 dev 分支开发完</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> add .</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">-m</span> <span class="cm-string">"feat: ..."</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push <span class="cm-attribute">-u</span> origin dev</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切换到（本地）master</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> checkout master</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 拉取最新</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> pull</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 将 dev 合并到（本地）master</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> merge dev</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 可能需要解决冲突，然后 add，commit</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 推送到远程 master</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push origin master</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 374px;"></div><div class="CodeMirror-gutters" style="display: none; height: 374px;"></div></div></div></pre><h3><a name='header-n229' class='md-header-anchor '></a>查看历史提交信息</h3><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看所有提交日志</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看某次 commit 的修改内容</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> show &lt;commit-id&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看某个文件的所有的修改内容</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> log <span class="cm-attribute">-p</span> &lt;filename&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看某个文件的最近 2 次的更新内容</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> log <span class="cm-attribute">-p</span> <span class="cm-attribute">-2</span> &lt;filename&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看最近一次所有的更新内容（如下两种方法）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> log <span class="cm-attribute">-p</span> <span class="cm-attribute">-1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> <span class="cm-builtin">diff</span> HEAD^</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看某个文件的最后一次更新内容由谁提交（对应到每一行）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> blame &lt;filename&gt;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 396px;"></div><div class="CodeMirror-gutters" style="display: none; height: 396px;"></div></div></div></pre><h3><a name='header-n231' class='md-header-anchor '></a>仓库迁移</h3><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 1. 本地有仓库 project1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 2. 在 github 新建仓库 project2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 3. 以镜像推送到 project2 上，可以保留 project1 的所有提交记录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push <span class="cm-attribute">--mirror</span> <span class="cm-builtin">git</span>@github.com:dudebing99/project2.git</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 88px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><h3><a name='header-n233' class='md-header-anchor '></a>合并多次提交</h3><ol start='' ><li>将头部指针指向要合并的第一个提交的前一个提交</li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> reset <span class="cm-attribute">--soft</span> &lt;commit id&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><ol start='2' ><li>重新提交</li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> commit <span class="cm-attribute">-m</span> <span class="cm-string">"New Commit Message"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><h3><a name='header-n242' class='md-header-anchor '></a>github 同步 fork 仓库</h3><blockquote><p>以同步 <code>master</code> 分支为例，其他分支同理</p></blockquote><ol start='' ><li>克隆已 <code>fork</code> 的项目到本地</li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> clone <span class="cm-builtin">git</span>@github.com:YOUR-USERNAME/YOUR-FORKED-REPO.git</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><ol start='2' ><li>添加远程原始仓库</li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> into/cloned/fork-repo</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> remote add upstream <span class="cm-builtin">git</span>://github.com/ORIGINAL-DEV-USERNAME/REPO-YOU-FORKED-FROM.git</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> fetch upstream</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 66px;"></div><div class="CodeMirror-gutters" style="display: none; height: 66px;"></div></div></div></pre><ol start='3' ><li>同远程原始仓库同步</li></ol><blockquote><p><code>git pull</code> 与 <code>git pull upstream master</code> 的区别，前者表示拉取自己远程仓库（默认为 <code>master</code> 分支），后者表示拉取外部的上游分支</p></blockquote><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> pull upstream master</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><ol start='4' ><li>同步之后推送到 <code>github</code> 已 <code>fork</code> 的项目</li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><h3><a name='header-n263' class='md-header-anchor '></a>github 提交 PR</h3><blockquote><p>一般地，为每一个 <code>PR</code> 创建一个分支</p></blockquote><ol start='' ><li>将远程分支（待提交 <code>PR</code> 的目标仓库的目标分支）检出作为本地分支 <code>&lt;local branch&gt;</code></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> checkout <span class="cm-attribute">-b</span> &lt;local branch&gt; upstream/master</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><ol start='2' ><li>将某次（或多次）提交 <code>cherry-pick</code> 到本地分支 <code>&lt;local branch&gt;</code></li></ol><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n273" mdtype="fences"># 一次提交
git cherry-pick 30cd5a3

# 多次提交 (commit from, commit to]
git cherry-pick &lt;commit from&gt;..&lt;commit to&gt;
</pre><ol start='3' ><li>将本地分支推到自己的远程仓库</li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">git</span> push origin &lt;remote branch&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><ol start='4' ><li>在 <code>github</code> 上面基于 <code>&lt;remote branch&gt;</code> 与 <code>upstream/master</code> 提交 <code>PR</code></li></ol><h2><a name='header-n281' class='md-header-anchor '></a>同步机器时间、硬件时钟</h2><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">yum install rdate <span class="cm-attribute">-y</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置时区</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">timedatectl set-timezone Asia/Shanghai</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 同步机器时间、硬件时钟</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rdate <span class="cm-attribute">-t</span> <span class="cm-number">30</span> <span class="cm-attribute">-s</span> time.nist.gov &amp;&amp; hwclock <span class="cm-attribute">-w</span> </span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><h2><a name='header-n283' class='md-header-anchor '></a>网络测速</h2><ol start='' ><li>安装 speedtest</li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">pip install speedtest-cli</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><ol start='2' ><li>测速</li></ol><blockquote><p>使用 speedtest 或者 speedtest-cli 命令测试，更精确测速，可以选择指定服务器</p></blockquote><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n293" mdtype="fences">root@iZwz978rorvlg75nct99l1Z:~# speedtest-cli
Retrieving speedtest.net configuration...
Testing from Aliyun Computing Co. (120.79.48.91)...
Retrieving speedtest.net server list...
Selecting best server based on ping...
Hosted by China Telecom Xiangyang Branch (XiangYang) [340.23 km]: 24.964 ms
Testing download speed................................................................................
Download: 494.36 Mbit/s
Testing upload speed................................................................................................
Upload: 201.21 Mbit/s
</pre><h2><a name='header-n294' class='md-header-anchor '></a>SSH 机器互信（免密登陆）</h2><p><strong>目标：</strong>client 被 server 信任，即，client 可以通过免密 ssh 登陆 server。</p><ol start='' ><li>client 产生公钥</li></ol><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n300" mdtype="fences">ssh-keygen -t rsa
# 后续回车即可
</pre><ol start='2' ><li>将步骤 1 中产生的 id_rsa.pub 拷贝并追加到 server 已授权 key 文件中</li></ol><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n304" mdtype="fences">cat id_rsa.pub &gt;&gt; root/.ssh/authorized_keys
</pre><ol start='3' ><li>重启 server 端 ssh 服务</li></ol><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n308" mdtype="fences"># Ubuntu，service ssh restart 即可
service sshd restart
</pre><h2><a name='header-n309' class='md-header-anchor '></a>PSSH 批量操作</h2><ol start='' ><li>目标机器均已经对操作机器做互信</li><li>通过 PSSH 批量操作，如下所示</li></ol><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n315" mdtype="fences" style="break-inside: unset;">root@iZwz9b1eyn1aqqy0s3qbadZ:~/pssh-tool# cat hosts 
120.76.61.90:22
47.99.204.62:22
116.62.234.240:22
47.99.178.161:22
47.98.49.93:22
47.99.194.5:22
47.52.193.118:22
47.105.140.237:22
47.105.65.96:22
root@iZwz9b1eyn1aqqy0s3qbadZ:~/pssh-tool# pssh -h hosts -l root -P date
120.76.61.90: Thu Dec 13 17:16:43 CST 2018
[1] 17:16:43 [SUCCESS] 120.76.61.90:22
47.52.193.118: Thu Dec 13 17:16:43 CST 2018
[2] 17:16:43 [SUCCESS] 47.52.193.118:22
47.99.204.62: Thu Dec 13 17:16:43 CST 2018
[3] 17:16:43 [SUCCESS] 47.99.204.62:22
47.98.49.93: Thu Dec 13 17:16:43 CST 2018
[4] 17:16:43 [SUCCESS] 47.98.49.93:22
47.99.178.161: Thu Dec 13 17:16:43 CST 2018
[5] 17:16:43 [SUCCESS] 47.99.178.161:22
116.62.234.240: Thu Dec 13 17:16:43 CST 2018
[6] 17:16:43 [SUCCESS] 116.62.234.240:22
47.99.194.5: Thu Dec 13 17:16:43 CST 2018
[7] 17:16:43 [SUCCESS] 47.99.194.5:22
47.105.65.96: Thu Dec 13 17:16:43 CST 2018
[8] 17:16:43 [SUCCESS] 47.105.65.96:22
47.105.140.237: Thu Dec 13 17:16:44 CST 2018
[9] 17:16:44 [SUCCESS] 47.105.140.237:22
</pre><h2><a name='header-n316' class='md-header-anchor '></a>SSH 禁用超时</h2><p><strong>目标：</strong>SSH 空闲之后，默认断掉，每次需要重连太过麻烦，可以修改 SSH 服务端设置禁用超时；也可以客户端定时发送心跳包保活。</p><ul><li>SSH 服务器</li></ul><ol start='' ><li>在 /etc/ssh/sshd_config 添加/修改如下配置项</li></ol><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n324" mdtype="fences">TCPKeepAlive yes
ClientAliveInterval 30
ClientAliveCountMax 999999
</pre><ol start='2' ><li>重启 server 端 ssh 服务</li></ol><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n328" mdtype="fences"># Ubuntu，service ssh restart 即可
service sshd restart
</pre><ul><li><p>SSH 客户端</p><p>在 /etc/ssh/ssh_config 添加/修改如下配置项 <code>ServerAliveInterval 30</code></p></li></ul><blockquote><p>在客户端配置后，就会有反空闲设置，即每 30s 会自动和服务端做一次确认。如果在 Windows 下使用 SecureCRT，如下操作即可</p></blockquote><p><img src='pic/securecrt/keepalive.png' alt='' referrerPolicy='no-referrer' /></p><blockquote><p>如果在 Windows 下使用 Putty，putty -&gt; Connection -&gt; Seconds between keepalives ( 0 to turn off )，默认为 0，改为30</p></blockquote><h2><a name='header-n338' class='md-header-anchor '></a>跳板机 Jumpserver 上传/下载文件</h2><blockquote><p><strong>需求：</strong>linux 服务器大多是通过 ssh 客户端来进行远程的登陆和管理，使用跳板机 Jumpserver，传输文件是个基础需求，可以借助 rz/sz 实现</p></blockquote><blockquote><p><strong>限制：</strong>rz/sz 只支持对文件（不支持文件夹）操作</p></blockquote><h3><a name='header-n343' class='md-header-anchor '></a>上传文件 rz</h3><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n344" mdtype="fences">rz -bye
</pre><h3><a name='header-n345' class='md-header-anchor '></a>下载文件 sz</h3><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n346" mdtype="fences">[xbuser@push4 push_server]$ sz ce.sh
rz
Starting zmodem transfer.  Press Ctrl+C to cancel.
  100%       1 KB    0 KB/s 00:00:25       0 Errors
</pre><h2><a name='header-n347' class='md-header-anchor '></a>MySQL 小技巧</h2><h3><a name='header-n348' class='md-header-anchor '></a>MySQL 清理控制台</h3><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n349" mdtype="fences">system clear
</pre><h3><a name='header-n350' class='md-header-anchor '></a>MySQL 查看表结构</h3><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n351" mdtype="fences">show create table multi_app_user_tbl;
</pre><p><strong>输出</strong></p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="basic" contenteditable="false" cid="n353" mdtype="fences">mysql&gt; show create table multi_app_user_tbl\G
*************************** 1. row ***************************
       Table: multi_app_user_tbl
Create Table: CREATE TABLE `multi_app_user_tbl` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '自增 ID',
  `uniq_user_id` varchar(64) NOT NULL COMMENT '用户唯一 ID',
  `org_user_id` int(11) NOT NULL COMMENT '用户 ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_org_user_id` (`org_user_id`),
  KEY `idx_uniq_user_id_user_id` (`uniq_user_id`)
) ENGINE=MyISAM AUTO_INCREMENT=4662 DEFAULT CHARSET=utf8
1 row in set (0.00 sec)
</pre><h3><a name='header-n354' class='md-header-anchor '></a>MySQL 随机排序</h3><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n355" mdtype="fences">select * from multi_app_user_tbl order by rand() limit 3;
</pre><p><strong>输出</strong></p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="basic" contenteditable="false" cid="n357" mdtype="fences" style="break-inside: unset;">mysql&gt; select * from multi_app_user_tbl order by rand() limit 3;
+------+--------------------------------------------+-------------+
| id   | uniq_user_id                               | org_user_id |
+------+--------------------------------------------+-------------+
| 1576 | advid:2b3f4008-9d2c-4410-8ff0-fb1a37021831 |      309614 |
| 2545 | advid:629e3632-83fc-41f6-b7a7-507d07da323a |      220043 |
| 2984 | advid:5a21e37d-8472-4b4b-aaad-c3828ab3a6fa |      190268 |
+------+--------------------------------------------+-------------+
3 rows in set (0.01 sec)

mysql&gt; select * from multi_app_user_tbl order by rand() limit 3;
+------+--------------------------------------------+-------------+
| id   | uniq_user_id                               | org_user_id |
+------+--------------------------------------------+-------------+
| 1615 | advid:eca90566-6048-4ff5-a1e3-c979d467221f |      307227 |
| 2646 | advid:a383d2fc-22e5-4ccc-b5d7-de80cc8f8eed |      283161 |
| 1913 | advid:fb082377-24a0-4936-a189-50563515c5cd |      281130 |
+------+--------------------------------------------+-------------+
3 rows in set (0.00 sec)
</pre><h3><a name='header-n358' class='md-header-anchor '></a>快捷选择 MySQL 实例</h3><ol start='' ><li>创建脚本 xdb.sh</li></ol><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n362" mdtype="fences" style="break-inside: unset;">#!/bin/bash

db=""
case $1 in
"log")
    db="mysql -uroot -p123456 -h log.topnews.com -Dlog"
    ;;
"reclog")
    db="mysql -uroot -p123456 -h 10.99.0.133 -Dreclog"
    ;;
"push")
    db="mysql -uroot -p123456 -h 10.99.0.56 -Dpush"
    ;;
*)
    echo "no param set"
esac

echo "Attention: connect to database: $1"
$db
</pre><ol start='2' ><li>chmod +x xdb.sh</li><li>使用 <code>./xdb.sh log</code> 即可快捷登陆 log.topnews.com 的数据库 log</li></ol><h3><a name='header-n369' class='md-header-anchor '></a>条件插入</h3><p><strong>场景：</strong>先根据条件判断某条记录是否存在，不存在则插入；存在即跳过。</p><p><strong>语法：</strong>insert into table(column1, column2, ..., columnN) select value1, value2, value3, ..., valueN from dual where not exists (condition clause)</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n372" mdtype="fences">insert into push_log_tbl(guid, origin_url, new_url, beg_ts) select '1111', '', '', sysdate() from dual where not exists (select guid from push_log_tbl where guid='1111');
</pre><h3><a name='header-n373' class='md-header-anchor '></a>timestamp 字段查询</h3><p><strong>场景一：</strong>查询某个时间范围的数据</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n375" mdtype="fences">SELECT `id`, `create_time` FROM `record` WHERE (create_time &gt;= '2011-05-27 11:27:00') ORDER BY id DESC LIMIT 0, 20
</pre><p><strong>场景二：</strong>查询某一天数据</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n377" mdtype="fences">select guid, content_id, title, long_text, new_url, ttl, icon, picture, push_enum from vntopnews_push.push_content_tbl where date_format(create_time,'%Y-%m-%d')='2011-05-27' order by create_time asc
</pre><h3><a name='header-n378' class='md-header-anchor '></a>时间相关函数</h3><h4><a name='header-n379' class='md-header-anchor '></a>查询 utc 时间戳、utc 日期、utc 时间、now()</h4><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n380" mdtype="fences">mysql&gt; select utc_timestamp(), utc_date(), utc_time(), now();
+---------------------+------------+------------+---------------------+
| utc_timestamp()     | utc_date() | utc_time() | now()               |
+---------------------+------------+------------+---------------------+
| 2018-05-26 08:27:00 | 2018-05-26 | 08:27:00   | 2018-05-26 16:27:00 |
+---------------------+------------+------------+---------------------+
</pre><h4><a name='header-n381' class='md-header-anchor '></a>now() 与 sysdate() 异同</h4><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n382" mdtype="fences">mysql&gt; select now(), sleep(3), now();
+---------------------+----------+---------------------+
| now()               | sleep(3) | now()               |
+---------------------+----------+---------------------+
| 2018-05-26 16:25:29 |        0 | 2018-05-26 16:25:29 |
+---------------------+----------+---------------------+
</pre><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n383" mdtype="fences">mysql&gt; select sysdate(), sleep(3), sysdate();
+---------------------+----------+---------------------+
| sysdate()           | sleep(3) | sysdate()           |
+---------------------+----------+---------------------+
| 2018-05-26 16:24:56 |        0 | 2018-05-26 16:24:59 |
+---------------------+----------+---------------------+
</pre><h4><a name='header-n384' class='md-header-anchor '></a>date_add 函数</h4><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n385" mdtype="fences">mysql&gt; select date_add(now(), interval -1 day) as t1, date_add(now(), interval 8 hour) as t2, now();
+---------------------+---------------------+---------------------+
| t1                  | t2                  | now()               |
+---------------------+---------------------+---------------------+
| 2018-05-25 16:39:34 | 2018-05-27 00:39:34 | 2018-05-26 16:39:34 |
+---------------------+---------------------+---------------------+
</pre><h3><a name='header-n386' class='md-header-anchor '></a>INSERT INTO SELECT 语句</h3><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n387" mdtype="fences">INSERT INTO table2 SELECT * FROM table1;
</pre><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n388" mdtype="fences">INSERT INTO table2 (column_name(s));
SELECT column_name(s) FROM table1;
</pre><h3><a name='header-n389' class='md-header-anchor '></a>查看表创建时间</h3><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n390" mdtype="fences">show table status
</pre><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n391" mdtype="fences">select CREATE_TIME from INFORMATION_SCHEMA.TABLES where TABLE_NAME='latest_active_user_tbl';
</pre><h3><a name='header-n392' class='md-header-anchor '></a>三目表达式</h3><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n393" mdtype="fences">select name,if(sex=0,'女','男') as sex from student;
</pre><h3><a name='header-n394' class='md-header-anchor '></a>between ... and ...</h3><p>SQL 中使用 <code>between ... and ...</code>，查询条件是闭区间，且上下限调换不等价，如下所示</p><p><code>between a and b =&gt; x ∈ [a, b] =&gt; x ≥ a &amp;&amp; x ≤ b</code></p><p><code>where id between a and b =&gt; where id &gt;= a and id &lt;= b</code></p><ul><li>查询 id ≥ 1 且 id ≤ 3 的记录</li></ul><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n401" mdtype="fences">select * from tbl where id between 1 and 3;
</pre><ul><li>查询 id ≥ 3 且 id ≤ 1 的记录</li></ul><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="sql" contenteditable="false" cid="n405" mdtype="fences">select * from tbl where id between 3 and 1;
</pre><p>所以，在处理起始终止范围查询业务逻辑时，SQL 中使用 <code>between ... and ...</code> 一定需要处理好上下限。即，前端、后端都应该确保上下限 <code>a ≤ b</code>。</p><h2><a name='header-n407' class='md-header-anchor '></a>NGINX 基础配置</h2><h3><a name='header-n408' class='md-header-anchor '></a>配置静态资源</h3><h4><a name='header-n409' class='md-header-anchor '></a>使用 alias 重定义路径</h4><p>静态资源如下所示</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n411" mdtype="fences">[kevin@iZwz9cynwitmm46uagetmvZ opt]$ tree -L 3 static*
static1
└── json
    └── dummy.json
static2
└── index.html

1 directory, 2 files
</pre><p>Nginx 配置如下</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n413" mdtype="fences" style="break-inside: unset;">server {
	listen       443 ssl http2 default_server;
	listen       [::]:443 ssl http2 default_server;
	server_name  bigsillybear.com;
	ssl_certificate /etc/letsencrypt/live/api.bigsillybear.com/fullchain.pem; # managed by Certbot
	ssl_certificate_key /etc/letsencrypt/live/api.bigsillybear.com/privkey.pem; # managed by Certbot
	ssl_session_cache shared:SSL:1m;
	ssl_session_timeout  10m;
	ssl_ciphers HIGH:!aNULL:!MD5;
	ssl_prefer_server_ciphers on;
	
	# Load configuration files for the default server block.
	include /etc/nginx/default.d/*.conf;
	
	# 使用正则表达式
	location ~  ^/hello1/(\w+).(\w+)$ {
	   alias /opt/static1/$2/$1.$2;
	}
	
	# 不使用正则表达式
	location /hello2/ {
	    alias /opt/static2/;
	    index  index.html index.htm;
	}
}
</pre><p>测试结果</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n415" mdtype="fences">[kevin@iZwz9cynwitmm46uagetmvZ opt]$ curl https://bigsillybear.com/hello1/dummy.json
{
    "id": 99,
    "msg": "hello world"
}
[kevin@iZwz9cynwitmm46uagetmvZ opt]$ curl https://bigsillybear.com/hello2/
&lt;html&gt;
    &lt;body&gt;
        &lt;h1&gt;Hello World&lt;/h1&gt;
        &lt;p&gt;Hello World&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre><h4><a name='header-n416' class='md-header-anchor '></a>使用 root 指定前缀</h4><p>静态资源如下所示</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n418" mdtype="fences">[kevin@iZwz9cynwitmm46uagetmvZ opt]$ tree -L 3 static3/
static3/
└── index.html

0 directories, 1 file
</pre><p>Nginx 配置如下</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n420" mdtype="fences" style="break-inside: unset;">server {
	listen       443 ssl http2 default_server;
	listen       [::]:443 ssl http2 default_server;
	server_name  bigsillybear.com;
	ssl_certificate /etc/letsencrypt/live/api.bigsillybear.com/fullchain.pem; # managed by Certbot
	ssl_certificate_key /etc/letsencrypt/live/api.bigsillybear.com/privkey.pem; # managed by Certbot
	ssl_session_cache shared:SSL:1m;
	ssl_session_timeout  10m;
	ssl_ciphers HIGH:!aNULL:!MD5;
	ssl_prefer_server_ciphers on;
	
	# Load configuration files for the default server block.
	include /etc/nginx/default.d/*.conf;
	
	location /static3/ {
    	root  /opt;
    	index  index.html index.htm;
    }
}
</pre><p>测试结果</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n422" mdtype="fences">[kevin@iZwz9cynwitmm46uagetmvZ opt]$ curl https://bigsillybear.com/static3/
&lt;html&gt;
    &lt;body&gt;
        &lt;h1&gt;Hello World&lt;/h1&gt;
        &lt;p&gt;Hello World&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre><h3><a name='header-n423' class='md-header-anchor '></a>Location 匹配规则</h3><h4><a name='header-n424' class='md-header-anchor '></a>语法规则</h4><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n425" mdtype="fences">location [ = | ~ | ~* | ^~ ] uri { ... }
location @name { ... }
</pre><p><code>location</code> 为关键字，后面跟着可选的修饰符，后面是要匹配的字符，花括号中是要执行的操作</p><ul><li><code>=</code> 表示精确匹配。只有请求的 <code>uri</code> 路径与后面的字符串完全相等时，才会命中</li><li><code>~</code> 表示该规则是使用正则定义的，区分大小写</li><li><code>~*</code> 表示该规则是使用正则定义的，不区分大小写</li><li><code>^~</code> 表示如果该符号后面的字符是最佳匹配，采用该规则，不再进行后续的查找</li></ul><h4><a name='header-n436' class='md-header-anchor '></a>匹配过程</h4><blockquote><p>匹配开始前，对请求的 <code>url</code> 序列化。例如，对 <code>%xx</code> 等字符进行解码，去除 <code>url</code> 中多个相连的 <code>/</code>，解析 <code>url</code> 中<code>.</code>，<code>..</code> </p></blockquote><blockquote><p><code>location</code> 有两种表示形式，一种是使用前缀字符，一种是使用正则。如果是正则的话，前面有 <code>~</code>或 <code>~*</code> 修饰符</p></blockquote><p>具体的匹配过程如下：</p><ol start='' ><li>首先先检查使用前缀字符定义的 <code>location</code>，选择最长匹配的项并记录下来</li><li>如果找到了精确匹配的 <code>location</code>，也就是使用了 <code>=</code> 修饰符的 <code>location</code>，结束查找，使用它的配置</li><li>按顺序查找使用正则定义的 <code>location</code>，如果匹配则停止查找，使用它定义的配置</li><li>如果没有匹配的正则 <code>location</code>，则使用前面记录的最长匹配前缀字符 <code>location</code></li></ol><h4><a name='header-n451' class='md-header-anchor '></a>示例详解</h4><p>假设有如下配置文件</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n453" mdtype="fences" style="break-inside: unset;">location = / {
    [ configuration A ]
}

location / {
    [ configuration B ]
}

location /user/ {
    [ configuration C ]
}

location ^~ /images/ {
    [ configuration D ]
}

location ~* \.(gif|jpg|jpeg)$ {
    [ configuration E ]
}
</pre><p>请求 <code>/</code> 精准匹配 A，不再往下查找</p><p>请求 <code>/index.html</code> 匹配 B。首先查找匹配的前缀字符，找到最长匹配是配置 B，接着又按照顺序查找匹配的正则。结果没有找到，因此使用先前标记的最长匹配，即配置 B</p><p>请求 <code>/user/index.html</code> 匹配 C。首先找到最长匹配 C，由于后面没有匹配的正则，所以使用最长匹配 C
请求 <code>/user/1.jpg</code> 匹配E。首先进行前缀字符的查找，找到最长匹配项 C，继续进行正则查找，找到匹配项 E。因此使用  E</p><p>请求 <code>/images/1.jpg</code>匹配 D。首先进行前缀字符的查找，找到最长匹配 D。但是，特殊的是它使用了 <code>^~</code> 修饰符，不再进行接下来的正则的匹配查找，因此使用 D。这里，如果没有前面的修饰符，其实最终的匹配是 E</p><p>请求 <code>/documents/about.html</code> 匹配 B。因为 B 表示任何以<code>/</code>开头的 URL 都匹配。在上面的配置中，只有 B 能满足，所以匹配 B</p><h4><a name='header-n459' class='md-header-anchor '></a>location @name 使用</h4><blockquote><p>@用来定义一个命名 location。主要用于内部重定向，不能用来处理正常的请求（该块不能被外部 Client 所访问，只能被内部配置指令所访问，比如 try_files、error_page）</p></blockquote><blockquote><p>命名 location 中不能再嵌套其它的命名 location</p></blockquote><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n464" mdtype="fences">location / {
    try_files $uri $uri/ @custom
}
location @custom {
    # do something
}
</pre><p>上例中，当尝试访问 uri 找不到对应的文件就重定向到我们自定义的命名 location（此处为custom）</p><h4><a name='header-n466' class='md-header-anchor '></a>URL 尾部的 <code>/</code></h4><ul><li>如果 URL 结构是 <code>https://domain.com/</code>的形式，尾部有没有 <code>/</code> 都不会造成重定向。因为浏览器在发起请求的时候，默认加上了 <code>/</code>，即使浏览器在地址栏里也不会显示 <code>/</code></li><li>如果 URL 的结构是 <code>https://domain.com/some-dir/</code>。尾部如果缺少 <code>/</code> 将导致重定向。因为根据约定，URL 尾部的 <code>/</code> 表示目录，没有 <code>/</code> 表示文件。所以访问 <code>/some-dir/</code> 时，服务器会自动去该目录下找对应的默认文件。如果访问 <code>/some-dir</code> 的话，服务器会先去找 <code>some-dir</code> 文件，找不到的话会将 <code>some-dir</code> 当成目录，重定向到 <code>/some-dir/</code>，去该目录下找默认文件</li></ul><h4><a name='header-n472' class='md-header-anchor '></a>配置静态资源</h4><p>静态资源有两种配置模式，目录匹配或后缀匹配，任选其一或搭配使用</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n474" mdtype="fences">location ^~ /static/ {
    root /webroot/static/;
}
</pre><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n475" mdtype="fences">location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ {
    root /webroot/res/;
}
</pre><h4><a name='header-n476' class='md-header-anchor '></a>实践原则</h4><ul><li>location 配置有两种形式，前缀字符和正则。查找匹配的时候，先查找前缀字符，选择最长匹配项，再查找正则。正则的优先级高于前缀字符</li><li><strong>使用正则定义的 <code>location</code> 在配置文件中出现的顺序很重要</strong>。正则的查找是按照在配置文件中的顺序进行的。因此正则的顺序很重要，建议越精细的放的越靠前，因为找到第一个匹配的正则后，查找就停止了，后面定义的正则就是再匹配也没有机会</li><li><strong>使用精确匹配可以提高查找的速度</strong>。如果根域名经常被访问的话建议使用 <code>=</code></li></ul><h4><a name='header-n484' class='md-header-anchor '></a>参考资料</h4><ul><li><a href='https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/'>https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/</a></li><li><a href='https://segmentfault.com/a/1190000013267839'>https://segmentfault.com/a/1190000013267839</a></li><li><a href='https://www.cnblogs.com/dadonggg/p/7797281.html'>https://www.cnblogs.com/dadonggg/p/7797281.html</a></li></ul><h2><a name='header-n492' class='md-header-anchor '></a>NGINX 性能优化</h2><blockquote><p>nginx 默认的配置 <code>/etc/nginx/nginx.conf</code>，当然，一般 <code>nginx.conf</code> 会引用其他目录的配置文件，例如目录 <code>conf.d</code>，如下讨论主要基于 <code>nginx.conf</code> 全局配置。</p></blockquote><blockquote><p>NGINX 官方配置说明：<a href='http://nginx.org/en/docs/ngx_core_module.html' target='_blank' class='url'>http://nginx.org/en/docs/ngx_core_module.html</a></p></blockquote><h3><a name='header-n497' class='md-header-anchor '></a>高层的配置</h3><blockquote><p><code>nginx.conf</code> 文件中，nginx 中有少数的几个高级配置在模块部分之上。</p></blockquote><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n500" mdtype="fences">user www-data;
pid /var/run/nginx.pid;

worker_processes auto;
worker_rlimit_nofile 100000;
</pre><ul><li><code>user</code> 配置 nginx 启动用户，默认即可</li><li><code>pid</code> 配置 nginx 进程号存放文件，默认即可</li><li><code>worker_process</code> 定义 nginx 对外提供 web 服务是的工作进程数量。最优值取决于诸多因素，包括但不限于 CPU 核心数量。一般配置为机器 CPU 核心数量即可（<code>auto</code> 将尝试自动检测机器 CPU 核心数量）</li><li><code>worker_rlimit_nofile</code> 更改工作进程的最大打开文件数限制。如果没设置的话，这个值为操作系统的限制。设置后你的操作系统和 nginx 可以处理比 <code>ulimit -a</code> 更多的文件，所以把这个值设高，这样 nginx 就不会出现 <code>too many open files</code> 的问题</li></ul><h3><a name='header-n510' class='md-header-anchor '></a>Events 模块</h3><blockquote><p>events 模块中包含 nginx 中所有处理连接的设置。</p></blockquote><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n513" mdtype="fences">events {
    worker_connections 2048;
    multi_accept on;
    use epoll;
}
</pre><ul><li><code>worker_connections</code> 设置单个工作进程同时打开的连接数限制，如高层配置中 <code>worker_rlimit_nofile</code> 设置了较高的值，可以适当地提高这个值</li></ul><blockquote><p>工作进程同时打开的连接数限制也由系统的可用 socket 连接数限制，所以设置不切实际的高没什么好处。</p></blockquote><ul><li><p><code>multi_accept</code> 设置 nginx 收到一个新连接通知后接受尽可能多的连接</p><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n522" mdtype="fences">Syntax:	multi_accept on | off;
Default:	
multi_accept off;
Context:	events
</pre><p>If <code>multi_accept</code> is disabled, a worker process will accept one new connection at a time. Otherwise, a worker process will accept all new connections at a time.</p></li><li><p><code>use</code> 设置用于复用客户端线程的轮询方法。如果你使用 <code>Linux 2.6+</code>，你应该使用 <code>epoll</code>。如果你使用 <code>BSD</code>，你应该使用 <code>kqueue</code></p></li></ul><blockquote><p>如果你不知道 nginx 该使用哪种轮询方法的话，不配置该选项即可，它会选择一个最适合你操作系统的。</p></blockquote><h2><a name='header-n528' class='md-header-anchor '></a>LINUX 内核调优参数</h2><blockquote><p>通过 <code>sysctl -a</code> 查看系统内核参数</p></blockquote><h3><a name='header-n531' class='md-header-anchor '></a>网络</h3><blockquote><p>Setting tcp_tw_recycle to 1 makes a Linux host drop TIME_WAIT connections much faster.  Instead of a predefined 2*MSL period of 60s, the host will use a timeout based on RTT estimate.  For LANs, it is usually several milliseconds. </p></blockquote><blockquote><p>Setting tcp_tw_reuse to 1 will make a host reuse the same connection quickly for outgoing connections.  </p></blockquote><blockquote><p>Many WEB sites say that setting the following tunable will change the 2*MSL (TIME_WAIT) period:</p><p># echo 30 &gt; /proc/sys/net/ipv4/tcp_fin_timeout </p><p>Is this correct? </p><p>Answer:  No.  The tcp(7) manpage states correctly that this tunable does something different: </p><p><span>	</span>tcp_fin_timeout (integer; default: 60) </p><p><span>	</span>This  specifies  how many seconds to wait for a final FIN packet before the socket is forcibly closed. </p><p>There is a hardwired constant, TCP_TIMEWAIT_LEN (defined to 60s), which is used in a number of places.  There is no way to change it without recompilation.   </p></blockquote><pre spellcheck="false" class="md-fences mock-cm md-end-block" lang="bash" contenteditable="false" cid="n544" mdtype="fences" style="break-inside: unset;">######################## cat /proc/sys/net/ipv4/tcp_syncookies
# 默认值：1
# 作用：是否打开 SYN Cookie 功能，该功能可以防止部分 SYN 攻击
net.ipv4.tcp_syncookies = 1

######################## cat /proc/sys/net/ipv4/ip_local_port_range
# 默认值：32768   61000
# 作用：可用端口的范围
net.ipv4.ip_local_port_range = 1024  65535

######################## cat /proc/sys/net/ipv4/tcp_timestamps 
# 默认值：1
# 作用：TCP 时间戳
net.ipv4.tcp_timestamps = 1

######################## cat /proc/sys/net/ipv4/tcp_tw_recycle
# 默认值：0
# 作用：针对 TIME-WAIT，不要开启
net.ipv4.tcp_tw_recycle = 0

######################## cat /proc/sys/net/ipv4/tcp_tw_reuse
# 默认值：0
# 作用：针对 TIME-WAIT，做为客户端可以启用
net.ipv4.tcp_tw_reuse = 1

######################## cat /proc/sys/net/ipv4/tcp_max_tw_buckets 
# 默认值：262144
# 作用：针对 TIME-WAIT，配置其上限。如果降低这个值，可以显著的发现 TIME-WAIT 的数量减少，但系统日志中可能出现如下记录：
# kernel: TCP: time wait bucket table overflow
# 对应的，如果升高这个值，可以显著的发现 TIME-WAIT 的数量增加。
# 综合考虑，保持默认值。
net.ipv4.tcp_max_tw_buckets = 262144

######################## cat /proc/sys/net/ipv4/tcp_max_orphans 
# 默认值：16384
# 作用：orphans 的最大值
net.ipv4.tcp_max_orphans = 3276800

######################## cat /proc/sys/net/ipv4/tcp_keepalive_intvl 
# 默认值：75
# 作用：探测失败后，间隔几秒后重新探测
net.ipv4.tcp_keepalive_intvl = 30

######################## cat /proc/sys/net/ipv4/tcp_keepalive_probes 
# 默认值：9
# 作用：探测失败后，最多尝试探测几次
net.ipv4.tcp_keepalive_probes = 3

######################## cat /proc/sys/net/ipv4/tcp_keepalive_time 
# 默认值：7200
# 作用：间隔多久发送1次 keepalive 探测包
net.ipv4.tcp_keepalive_time = 1200

######################## cat /proc/sys/net/ipv4/tcp_max_syn_backlog
# 默认值：128
# 作用：增大 SYN 队列的长度，容纳更多连接
net.ipv4.tcp_max_syn_backlog = 819200

######################## cat /proc/sys/net/core/somaxconn
# 默认值：128
# 作用：已经成功建立连接的套接字将要进入队列的长度
net.core.somaxconn = 65536
</pre><p>&nbsp;</p></div>
</body>
</html>